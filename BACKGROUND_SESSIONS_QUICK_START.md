# 后台会话功能 - 快速开始

## 什么是后台会话？

后台会话允许终端任务在服务端持续运行，即使你关闭浏览器或切换设备。就像 tmux 或 screen，但是基于 Web 的。

## 快速体验

### 1. 启动一个长时间任务

```bash
# 创建一个新的终端会话
# 运行一个长时间任务
for i in {1..100}; do
  echo "任务进度: $i/100"
  sleep 2
done
echo "任务完成！"
```

### 2. 关闭浏览器

直接关闭浏览器标签页或整个浏览器。

**会发生什么？**
- ✅ 任务继续在服务端运行
- ✅ 输出继续被捕获和保存
- ✅ 会话标记为"后台运行中"

### 3. 重新打开

几分钟后，重新打开浏览器，登录系统。

**你会看到：**
- ✅ 会话仍然存在
- ✅ 完整的历史输出
- ✅ 任务继续运行
- ✅ 信息栏显示"后台运行中"

### 4. 多设备访问

在另一台设备上登录，打开同一个会话。

**你会看到：**
- ✅ 相同的终端输出
- ✅ 实时同步
- ✅ 信息栏显示"2 个客户端"

## 实际使用场景

### 场景 1: 编译大型项目

```bash
# 启动编译（可能需要几小时）
./build-all.sh

# 关闭浏览器去做其他事情
# 编译继续进行

# 随时回来查看进度
# 看到完整的编译日志
```

### 场景 2: 监控日志

```bash
# 启动日志监控
tail -f /var/log/app.log

# 关闭浏览器
# 日志继续被读取和保存

# 需要时重新连接
# 看到最近的日志输出
```

### 场景 3: 数据库备份

```bash
# 启动备份任务
mysqldump -u root -p database > backup.sql

# 任务在后台运行
# 完成后可以看到结果
```

### 场景 4: 团队协作

```bash
# 团队成员 A 启动调试会话
ssh production-server
tail -f /var/log/error.log

# 团队成员 B 从另一台电脑连接
# 两人同时看到相同的日志
# 可以一起分析问题
```

## 界面说明

### 信息栏标签

#### 🕐 创建时间
显示会话创建的时间

#### 📐 终端尺寸
显示终端的列数和行数（如 80×24）

#### 💾 缓存大小
显示已保存的输出大小

#### 👥 客户端数量
- **1 个客户端** - 只有你连接
- **2 个客户端** - 有其他人也在看
- **3+ 个客户端** - 多人协作

#### ⚡ 后台运行中
- 显示这个标签表示会话在后台运行
- 没有客户端连接，但任务继续执行

### 操作按钮

#### 适配尺寸
当终端尺寸与保存的不匹配时显示，点击调整到正确尺寸

#### 详情
查看会话的详细信息：
- 会话 ID
- 创建时间
- 最后活动时间
- 终端尺寸
- 缓存大小
- 工作目录
- 进程 ID
- 运行状态
- 连接客户端数量
- 是否后台运行

## 常见问题

### Q: 会话会保存多久？
A: 默认 7 天。可以在设置中调整超时时间。

### Q: 关闭浏览器会影响任务吗？
A: 不会！任务继续在服务端运行。

### Q: 可以多人同时连接吗？
A: 可以！所有人看到相同的输出，任何人的输入都会同步。

### Q: 如何真正关闭一个会话？
A: 点击标签页的关闭按钮（×），会话才会真正关闭。

### Q: 输出会保存多少？
A: 默认保存最近 5000 行。可以在设置中调整。

### Q: 会话在后台运行时消耗资源吗？
A: 会消耗少量 CPU 和内存，但经过优化，影响很小。

### Q: 如何查看哪些会话在后台运行？
A: 打开终端页面，查看信息栏的"后台运行中"标签。

### Q: 可以在手机上访问吗？
A: 可以！在任何设备上登录都能访问你的会话。

## 最佳实践

### 1. 使用有意义的会话名称
```
❌ "终端 1"
✅ "生产环境部署"
✅ "数据库备份任务"
✅ "日志监控"
```

### 2. 定期清理不需要的会话
- 任务完成后关闭会话
- 避免积累太多闲置会话

### 3. 监控长时间任务
```bash
# 使用进度指示
for i in {1..100}; do
  echo "[$i/100] 处理中..."
  # 你的任务
done

# 或使用时间戳
while true; do
  echo "[$(date)] 状态检查..."
  # 你的任务
  sleep 60
done
```

### 4. 多人协作时沟通
- 在会话名称中注明用途
- 查看客户端数量，知道有多少人在看
- 避免同时输入命令造成混乱

## 高级技巧

### 1. 后台任务模式
```bash
# 启动任务后立即断开
./long-task.sh &
# 关闭浏览器，任务继续运行
```

### 2. 定时检查
```bash
# 每小时输出一次状态
while true; do
  echo "=== $(date) ==="
  # 检查状态
  sleep 3600
done
```

### 3. 任务完成通知
```bash
# 任务完成后输出明显的标记
./task.sh
echo "================================"
echo "任务完成！时间: $(date)"
echo "================================"
```

### 4. 会话恢复检查
```bash
# 在脚本开始时输出信息
echo "脚本启动: $(date)"
echo "PID: $$"
echo "工作目录: $(pwd)"
echo "================================"

# 你的任务
./main-task.sh

echo "================================"
echo "脚本结束: $(date)"
```

## 故障排查

### 问题: 看不到"后台运行中"标签
**原因:** 可能还有客户端连接，或会话已停止
**解决:** 刷新页面，检查会话详情

### 问题: 重新连接后看不到历史输出
**原因:** 缓冲区可能已满或会话已超时
**解决:** 增加缓冲区大小，或减少输出量

### 问题: 多个客户端输出不同步
**原因:** 网络延迟或连接问题
**解决:** 检查网络连接，刷新页面

### 问题: 会话意外关闭
**原因:** 超时或服务器重启
**解决:** 检查超时设置，确保服务器稳定运行

## 下一步

- 阅读 [PERSISTENT_BACKGROUND_SESSIONS.md](PERSISTENT_BACKGROUND_SESSIONS.md) 了解技术细节
- 在设置页面调整会话超时和缓冲区大小
- 尝试在多个设备上同时连接同一会话
- 探索更多使用场景

## 反馈

如果你发现问题或有改进建议，请：
1. 查看后端日志
2. 检查浏览器控制台
3. 记录重现步骤
4. 提交反馈
