# 交互式 CLI 工具支持 - 测试指南

## 快速测试步骤

### 1. 重启服务

首先需要重启后端服务以应用更改：

```bash
# 停止当前运行的服务
# 按 Ctrl+C 停止

# 重新启动服务
./start.sh
```

或者分别重启：

```bash
# 重启后端
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 重启前端（在另一个终端）
cd frontend
npm run dev
```

### 2. 基本功能测试

#### 测试 1: 终端环境变量
在终端中运行：
```bash
echo "TERM: $TERM"
echo "COLORTERM: $COLORTERM"
echo "TERM_PROGRAM: $TERM_PROGRAM"
```

**预期输出:**
```
TERM: xterm-256color
COLORTERM: truecolor
TERM_PROGRAM: xterm
```

#### 测试 2: 颜色支持
```bash
echo -e "\033[31m红色\033[0m \033[32m绿色\033[0m \033[33m黄色\033[0m \033[34m蓝色\033[0m"
```

**预期结果:** 应该看到彩色文字

#### 测试 3: 终端尺寸
```bash
echo "列数: $(tput cols), 行数: $(tput lines)"
```

**预期结果:** 显示当前终端的列数和行数

### 3. 交互式工具测试

#### 测试 vim
```bash
vim test.txt
```

**测试项目:**
- ✅ 使用方向键移动光标
- ✅ 使用 hjkl 移动光标
- ✅ 输入文字，检查光标位置
- ✅ 使用 :w 保存，:q 退出
- ✅ 调整浏览器窗口大小，vim 应该自动调整

#### 测试 less
```bash
# 创建一个长文件用于测试
seq 1 1000 > numbers.txt
less numbers.txt
```

**测试项目:**
- ✅ 使用方向键上下滚动
- ✅ 使用 Page Up/Down 翻页
- ✅ 使用 / 搜索
- ✅ 按 q 退出
- ✅ 界面显示正常，无格式错误

#### 测试 top
```bash
top
```

**测试项目:**
- ✅ 界面正常显示
- ✅ 数据实时更新
- ✅ 使用方向键滚动
- ✅ 按 q 退出

#### 测试 nano
```bash
nano test.txt
```

**测试项目:**
- ✅ 使用方向键移动
- ✅ 输入文字
- ✅ 底部菜单正常显示
- ✅ Ctrl+X 退出

### 4. Claude Code 测试

如果安装了 Claude Code：

```bash
claude
```

**测试项目:**
- ✅ 菜单界面正常显示
- ✅ 使用方向键导航菜单
- ✅ 选项高亮正确
- ✅ 没有格式错误或光标错位
- ✅ 可以正常选择和执行命令

### 5. 跨设备测试

#### 步骤 1: 在设备 A 创建会话
1. 登录系统
2. 创建一个新的终端会话，命名为"测试会话"
3. 运行 `vim test.txt` 或其他交互式工具
4. 记录终端尺寸（在信息栏显示）

#### 步骤 2: 在设备 B 打开同一会话
1. 在另一个设备或浏览器登录
2. 打开"测试会话"
3. 检查信息栏显示的尺寸
4. 如果尺寸不同，点击"适配尺寸"按钮

#### 步骤 3: 验证
1. 运行交互式工具（如 vim）
2. 使用方向键导航
3. 检查是否有格式错误

**预期结果:** 适配尺寸后，交互式工具应该正常工作

### 6. 窗口大小变化测试

#### 步骤 1: 打开交互式工具
```bash
vim test.txt
```

#### 步骤 2: 调整浏览器窗口
- 拖动浏览器窗口边缘改变大小
- 或使用浏览器的缩放功能

#### 步骤 3: 观察
- vim 应该自动调整界面
- 光标位置应该保持正确
- 没有显示错误

**预期结果:** 交互式工具自动适应新的窗口大小

### 7. 信号处理测试

#### 测试 Ctrl+C
```bash
# 运行一个长时间命令
sleep 100
# 按 Ctrl+C 中断
```

**预期结果:** 命令被中断，返回到 shell 提示符

#### 测试 Ctrl+Z
```bash
# 运行一个命令
top
# 按 Ctrl+Z 暂停
# 使用 fg 恢复
fg
```

**预期结果:** 命令可以暂停和恢复

### 8. 性能测试

#### 测试大量输出
```bash
# 输出大量文本
seq 1 10000
```

**预期结果:** 
- 输出流畅，无卡顿
- 可以使用 Ctrl+C 中断
- 滚动条正常工作

#### 测试快速输入
在 vim 或 nano 中快速输入大量文字

**预期结果:**
- 输入响应及时
- 没有字符丢失
- 光标位置准确

## 常见问题排查

### 问题 1: 方向键显示为 ^[[A ^[[B 等
**原因:** 终端类型设置不正确  
**解决:** 检查 TERM 环境变量是否为 xterm-256color

### 问题 2: 颜色显示不正常
**原因:** COLORTERM 未设置  
**解决:** 检查 COLORTERM 环境变量是否为 truecolor

### 问题 3: vim 界面错位
**原因:** 终端尺寸不匹配  
**解决:** 点击"适配尺寸"按钮，或调整浏览器窗口大小

### 问题 4: 窗口大小改变后界面不更新
**原因:** SIGWINCH 信号未正确发送  
**解决:** 检查后端日志，确认没有 SIGWINCH 相关错误

### 问题 5: Ctrl+C 不工作
**原因:** 终端属性未正确设置  
**解决:** 检查后端日志，确认 termios 配置成功

## 成功标准

所有以下测试都应该通过：

- ✅ 环境变量正确设置
- ✅ 颜色正常显示
- ✅ vim 可以正常使用，方向键工作正常
- ✅ less 可以正常浏览文件
- ✅ top 界面正常显示和更新
- ✅ Claude Code 菜单导航正常
- ✅ 跨设备会话恢复正常
- ✅ 窗口大小变化时自动调整
- ✅ Ctrl+C, Ctrl+Z 等信号正常工作
- ✅ 大量输出时性能良好

## 报告问题

如果发现问题，请记录：

1. **问题描述**: 详细描述问题现象
2. **重现步骤**: 如何重现问题
3. **环境信息**: 
   - 浏览器类型和版本
   - 操作系统
   - 终端尺寸
4. **错误信息**: 
   - 浏览器控制台错误
   - 后端日志错误
5. **截图**: 如果可能，提供问题截图

## 回滚步骤

如果修改导致严重问题，可以回滚：

### 回滚后端
```bash
cd backend
git checkout app/services/terminal.py
# 重启服务
```

### 回滚前端
```bash
cd frontend
git checkout src/views/Terminal.vue
# 重新构建
npm run build
```

## 下一步

测试通过后，可以：
1. 部署到生产环境
2. 更新用户文档
3. 通知用户新功能
4. 收集用户反馈
