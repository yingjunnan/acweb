# 配置更新说明

## 新增配置项

在终端设置页面新增了两个会话管理相关的配置项：

### 1. 会话超时 (session_timeout)
- **位置**: 终端设置 → 会话管理 → 会话超时
- **范围**: 5分钟 - 2小时（300秒 - 7200秒）
- **默认值**: 1小时（3600秒）
- **步长**: 5分钟（300秒）
- **说明**: 终端会话在无活动后保持的时间，超时后会话会被自动清理

#### 使用建议
- **短期任务（5-30分钟）**: 适合快速操作，节省服务器资源
- **日常开发（1小时）**: 默认设置，适合大多数场景
- **长时间任务（2小时）**: 适合编译、部署等耗时操作

### 2. 缓存行数 (buffer_size)
- **位置**: 终端设置 → 会话管理 → 缓存行数
- **范围**: 100 - 5000 行
- **默认值**: 1000 行
- **步长**: 100 行
- **说明**: 终端输出缓存的最大行数，用于重连时恢复输出

#### 内存占用估算
系统会实时显示当前配置的内存占用估算：

- **100 行**: 约 19.5 KB（每个会话）
- **500 行**: 约 97.7 KB（每个会话）
- **1000 行**: 约 195.3 KB（每个会话）
- **2500 行**: 约 488.3 KB（每个会话）
- **5000 行**: 约 976.6 KB（每个会话）

**计算方式**:
- 假设每行平均 80 个字符
- 每个字符约 2 字节（UTF-8 编码）
- 加上数据结构开销，每行约 200 字节
- 总内存 = 行数 × 200 字节

**注意**: 
- 每个终端会话独立占用内存
- 如果有 5 个会话，每个缓存 1000 行，总共约占用 1 MB 内存
- 建议根据服务器资源和实际需求合理设置

#### 使用建议
- **100-500行**: 节省内存，适合简单命令（每会话 < 100 KB）
- **1000行**: 默认设置，适合大多数场景（每会话约 200 KB）
- **2500-5000行**: 适合需要查看大量历史输出的场景（每会话 500 KB - 1 MB）

## 配置界面

### 会话超时滑块
```
5分钟 -------- 30分钟 -------- 1小时 -------- 2小时
```
实时显示当前设置，例如：`当前设置: 1 小时 30 分钟`

### 缓存行数滑块
```
100 -------- 1000 -------- 2500 -------- 5000
```
实时显示当前设置，例如：`当前设置: 1500 行`

## 配置生效时机

### 立即生效
- 刷新间隔：修改后立即应用到仪表盘

### 下次会话生效
- 会话超时：新创建的会话使用新配置
- 缓存行数：新创建的会话使用新配置
- 默认路径：新创建的会话使用新配置
- Shell：新创建的会话使用新配置
- 字体大小：新创建的会话使用新配置
- 主题：新创建的会话使用新配置

### 已有会话
已经创建的终端会话会继续使用创建时的配置，不受新配置影响。

## 技术实现

### 后端
```python
class TerminalConfig(BaseModel):
    session_timeout: int = 3600  # 会话超时（秒）
    buffer_size: int = 1000  # 缓存行数

class TerminalManager:
    def update_config(self, session_timeout, buffer_size):
        self.session_timeout = session_timeout
        self.buffer_size = buffer_size
```

### 前端
```javascript
const formState = reactive({
  session_timeout: 3600,
  buffer_size: 1000
})

const formatTimeout = (seconds) => {
  // 格式化显示时间
}
```

## 配置文件

配置保存在 `terminal_config.json` 文件中：

```json
{
  "default_path": "~",
  "shell": "/bin/bash",
  "font_size": 14,
  "theme": "dark",
  "refresh_interval": 3,
  "session_timeout": 3600,
  "buffer_size": 1000
}
```

## 注意事项

### 会话超时
1. **资源占用**: 超时时间越长，服务器资源占用越多
2. **安全性**: 较短的超时时间更安全
3. **便利性**: 较长的超时时间更方便
4. **建议**: 根据实际使用场景平衡设置

### 缓存行数
1. **内存占用**: 缓存行数越多，内存占用越大
2. **重连体验**: 缓存越多，重连时能看到更多历史输出
3. **性能影响**: 过大的缓存可能影响性能
4. **建议**: 一般情况下 1000 行足够使用

## 使用场景示例

### 场景 1: 快速操作
```
会话超时: 5分钟
缓存行数: 500行
适用: 快速查看日志、执行简单命令
```

### 场景 2: 日常开发
```
会话超时: 1小时
缓存行数: 1000行
适用: 日常开发、调试、测试
```

### 场景 3: 长时间任务
```
会话超时: 2小时
缓存行数: 2500行
适用: 编译、部署、数据处理
```

### 场景 4: 日志监控
```
会话超时: 1小时
缓存行数: 5000行
适用: 实时监控日志、查看大量输出
```

## 故障排查

### 问题: 会话过早被清理
**解决**: 增加会话超时时间

### 问题: 重连后看不到历史输出
**解决**: 增加缓存行数

### 问题: 服务器内存占用高
**解决**: 减少缓存行数或会话超时时间

### 问题: 配置不生效
**解决**: 
1. 确认已点击"保存所有配置"
2. 关闭旧会话，创建新会话
3. 检查配置文件是否正确保存
